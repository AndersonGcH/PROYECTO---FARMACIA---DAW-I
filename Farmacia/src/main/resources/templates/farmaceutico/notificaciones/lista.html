<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Notificaciones - Sistema Farmacéutico</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .notification-item {
            border-left: 4px solid #6c757d;
            transition: all 0.2s;
        }
        .notification-item:hover {
            background-color: rgba(0, 123, 255, 0.03);
            transform: translateX(2px);
        }
        .notification-bajo-stock {
            border-left-color: #ffc107 !important;
        }
        .notification-proximo-caducar {
            border-left-color: #fd7e14 !important;
        }
        .notification-pendiente {
            background-color: rgba(255, 193, 7, 0.05);
        }
        .notification-atendida {
            opacity: 0.8;
            background-color: rgba(40, 167, 69, 0.05);
        }
        .badge-notification {
            font-size: 0.75em;
            padding: 3px 8px;
        }
        .empty-state {
            opacity: 0.6;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        
        <!-- Título y controles -->
        <div class="row mb-4">
            <div class="col-md-8">
                <h2 class="mb-0">
                    <i class="bi bi-bell"></i> Notificaciones del Sistema
                </h2>
                <p class="text-muted">
                    Notificaciones automáticas generadas por bajo stock y próximas caducidades.
                    <span class="badge bg-secondary" th:if="${total}">Total: <span th:text="${total}">0</span></span>
                </p>
            </div>
            <div class="col-md-4 d-flex align-items-center justify-content-end">
                <div class="btn-group" role="group">
                    <a th:href="@{/farmaceutico/notificaciones}" 
                       class="btn btn-outline-secondary"
                       th:classappend="${estado == null and tipo == null} ? 'active' : ''">
                        <i class="bi bi-grid-3x3-gap"></i> Todas
                    </a>
                    <a th:href="@{/farmaceutico/notificaciones/pendientes}" 
                       class="btn btn-outline-warning"
                       th:classappend="${estado == 'PENDIENTE'} ? 'active' : ''">
                        <i class="bi bi-clock"></i> Pendientes
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Mensajes -->
        <div th:if="${success}" class="alert alert-success alert-dismissible fade show">
            <span th:text="${success}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show">
            <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        
        <!-- Lista de notificaciones -->
        <div class="card">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-list-ul"></i> 
                    <span th:text="${titulo}">Notificaciones</span>
                    <span th:if="${tipo}" class="badge bg-secondary ms-2" th:text="${tipo}"></span>
                </h5>
                <form th:action="@{/farmaceutico/notificaciones/generar-automaticas}" method="post" class="mb-0">
                    <button type="submit" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-arrow-clockwise"></i> Generar Automáticas
                    </button>
                </form>
            </div>
            
            <div class="card-body p-0">
                <!-- Si hay notificaciones -->
                <div th:unless="${#lists.isEmpty(notificaciones)}">
                    <div class="list-group list-group-flush">
						<div th:each="notif : ${notificaciones}" 
						     class="list-group-item notification-item p-4"
							 th:classappend="${(notif.tipo == 'BAJO_STOCK' ? 'notification-bajo-stock' : (notif.tipo == 'PROXIMO_CADUCAR' ? 'notification-proximo-caducar' : '')) 
							                  + ' ' + (notif.estado == 'PENDIENTE' ? 'notification-pendiente' : 'notification-atendida')}">



                            <div class="row">
                                <!-- Icono y tipo -->
                                <div class="col-md-1 text-center">
                                    <div th:if="${notif.tipo == 'BAJO_STOCK'}" 
                                         class="bg-warning text-white rounded-circle d-inline-flex align-items-center justify-content-center" 
                                         style="width: 40px; height: 40px;">
                                        <i class="bi bi-exclamation-triangle fs-5"></i>
                                    </div>
                                    <div th:if="${notif.tipo == 'PROXIMO_CADUCAR'}" 
                                         class="bg-danger text-white rounded-circle d-inline-flex align-items-center justify-content-center" 
                                         style="width: 40px; height: 40px;">
                                        <i class="bi bi-calendar-x fs-5"></i>
                                    </div>
                                </div>
                                
                                <!-- Contenido de la notificación -->
                                <div class="col-md-8">
                                    <h6 class="mb-1" th:text="${notif.mensaje}">
                                        Mensaje de notificación
                                    </h6>
                                    
                                    <div class="small text-muted mb-2">
                                        <i class="bi bi-capsule"></i> 
                                        Medicamento: 
                                        <a th:href="@{/farmaceutico/stock/medicamento/} + ${notif.idMedicamento}" 
                                           class="text-decoration-none">
                                            <strong th:text="${notif.nombreMedicamento}">Medicamento</strong>
                                        </a>
                                        <span class="mx-2">•</span>
                                        <i class="bi bi-building"></i> 
                                        Sede: <span th:text="${notif.nombreSede}">Sede</span>
                                        <span class="mx-2">•</span>
                                        <i class="bi bi-box"></i> 
                                        Stock: <span th:text="${notif.stockMedicamento}">0</span> unidades
                                    </div>
                                    
                                    <div class="d-flex flex-wrap gap-2">
                                        <span th:if="${notif.tipo == 'BAJO_STOCK'}" 
                                              class="badge bg-warning badge-notification">
                                            <i class="bi bi-exclamation-triangle"></i> BAJO STOCK
                                        </span>
                                        <span th:if="${notif.tipo == 'PROXIMO_CADUCAR'}" 
                                              class="badge bg-danger badge-notification">
                                            <i class="bi bi-calendar-x"></i> PRÓXIMA CADUCIDAD
                                        </span>
                                        <span th:if="${notif.estado == 'PENDIENTE'}" 
                                              class="badge bg-warning badge-notification">
                                            <i class="bi bi-clock"></i> PENDIENTE
                                        </span>
                                        <span th:if="${notif.estado == 'ATENDIDA'}" 
                                              class="badge bg-success badge-notification">
                                            <i class="bi bi-check-circle"></i> ATENDIDA
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- Fecha y acciones -->
                                <div class="col-md-3 text-end">
                                    <div class="small text-muted mb-2">
                                        <i class="bi bi-clock"></i>
                                        <span th:text="${notif.fechaFormateada}">01/01/2024 10:30</span>
                                    </div>
                                    
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Si NO hay notificaciones -->
                <div th:if="${#lists.isEmpty(notificaciones)}" class="text-center py-5 empty-state">
                    <i class="bi bi-bell-slash display-1 text-muted"></i>
                    <h5 class="mt-3 text-muted">No hay notificaciones</h5>
                    <p class="text-muted">El sistema generará notificaciones automáticamente cuando:</p>
                    <div class="row justify-content-center mt-3">
                        <div class="col-md-8">
                            <div class="alert alert-warning">
                                <ul class="mb-0 text-start">
                                    <li>Un medicamento tenga <strong>stock bajo (menos de 10 unidades)</strong></li>
                                    <li>Un lote esté <strong>próximo a caducar (≤30 días)</strong></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <form th:action="@{/farmaceutico/notificaciones/generar-automaticas}" method="post">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="bi bi-arrow-clockwise"></i> Generar Notificaciones
                            </button>
                        </form>
                        <p class="small text-muted mt-2">
                            <i class="bi bi-info-circle"></i> 
                            Las notificaciones se envían automáticamente a la vista del Gestor
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="card-footer bg-light">
                <div class="row">
                    <div class="col">
                        <small class="text-muted">
                            <i class="bi bi-building"></i> Sede ID: <span th:text="${sedeId}">1</span>
                            | <i class="bi bi-clock"></i> Actualizado: 
                            <span th:text="${#temporals.format(#temporals.createNow(), 'dd/MM/yyyy HH:mm')}"></span>
                        </small>
                    </div>
                    <div class="col text-end">
                        <small>
                            <span class="badge bg-warning me-2">
                                <i class="bi bi-exclamation-triangle"></i> Bajo Stock
                            </span>
                            <span class="badge bg-danger">
                                <i class="bi bi-calendar-x"></i> Próxima Caducidad
                            </span>
                        </small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Menú de navegación -->
        <div class="mt-4 mb-5">
            <a th:href="@{/farmaceutico/medicamentos}" class="btn btn-outline-secondary me-2">
                <i class="bi bi-capsule"></i> Medicamentos
            </a>
            <a th:href="@{/farmaceutico/lotes}" class="btn btn-outline-secondary me-2">
                <i class="bi bi-box-seam"></i> Lotes
            </a>
            <a th:href="@{/farmaceutico/stock}" class="btn btn-outline-secondary me-2">
                <i class="bi bi-graph-up"></i> Stock
            </a>
        </div>
        
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>